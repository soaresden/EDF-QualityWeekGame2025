<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.25, viewport-fit=cover, user-scalable=yes">
  <title>Quality Inspector - EDF</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Courier New', monospace; background: #0a0e27; color: #ccc; overflow: hidden; height: 100vh; touch-action: manipulation; }
    
    canvas { 
      touch-action: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    .header {
      background: linear-gradient(90deg, #0254A0 0%, #00A8E9 100%);
      color: white;
      padding: 8px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      border-bottom: 3px solid #00A8E9;
      height: 45px;
    }

    .header-left h1 { font-size: 1.2rem; margin-bottom: 0; }
    .header-right { text-align: right; font-size: 0.85rem; }

    .timer-bar-full {
      background: #1a1f2e;
      border-bottom: 2px solid #FF5716;
      padding: 8px 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
    }

    .timer-display { 
      font-size: 1.8rem; 
      font-weight: bold; 
      color: #FF5716; 
      min-width: 90px;
      text-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
    }

    .timer-bar { 
      flex: 1;
      height: 8px; 
      background: #0f1419; 
      border-radius: 4px; 
      overflow: hidden; 
      border: 2px solid #FF5716;
    }

    .timer-fill { 
      height: 100%; 
      width: 100%; 
      background: linear-gradient(90deg, #10B981, #00A8E9, #FF5716); 
      transition: width 0.1s linear;
    }

    .stats-bar {
      background: rgba(0, 168, 233, 0.08);
      border-bottom: 1px solid #00A8E9;
      padding: 6px 20px;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 15px;
      align-items: center;
    }

    .stat-item { text-align: center; }
    .stat-label { font-size: 0.65rem; color: #888; text-transform: uppercase; margin-bottom: 2px; }
    .stat-val { 
      font-size: 1.4rem; 
      font-weight: bold; 
      color: #10B981;
      text-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
    }
    .stat-val.warning { color: #FF5716; text-shadow: 0 0 8px rgba(245, 158, 11, 0.5); }
    .stat-val.danger { color: #EF4444; text-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }

    .main-container {
      display: grid;
      grid-template-columns: 140px 1fr 140px;
      height: calc(100vh - 130px);
      gap: 0;
    }

    .left-panel {
      background: #1a1f2e;
      border-right: 1px solid #00A8E9;
      padding: 8px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .left-panel h3 { color: #00A8E9; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 3px; border-bottom: 1px solid #00A8E9; padding-bottom: 2px; }
    .queue-items { display: flex; flex-direction: column; gap: 3px; flex: 1; }
    .queue-item { background: #0f1419; padding: 5px; border-radius: 3px; border-left: 2px solid #666; font-size: 0.7rem; color: #999; }
    .queue-item.active { border-left-color: #00A8E9; background: rgba(0, 168, 233, 0.1); color: #00A8E9; font-weight: bold; }

    .center-area {
      background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 10px;
      gap: 10px;
    }

    .canvas-container {
      position: relative;
      width: 90%;
      max-width: 500px;
      z-index: 10;
    }

    #productCanvas {
      width: 100%;
      height: auto;
      border: 3px solid #00A8E9;
      border-radius: 6px;
      box-shadow: 0 0 30px rgba(0, 168, 233, 0.4);
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><text x="0" y="17" font-size="16">üîç</text></svg>') 2 17, auto;
      background: white;
      display: block;
      position: relative;
      z-index: 1;
    }

    .inspection-zone {
      position: fixed;
      width: 150px;
      height: 150px;
      border: 4px solid #FF5716;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(245, 158, 11, 0.4), rgba(245, 158, 11, 0.1));
      pointer-events: none;
      z-index: 99;
      box-shadow: 0 0 50px #FF5716, inset 0 0 50px rgba(245, 158, 11, 0.6);
      transform: translate(-50%, -50%);
      display: none;
    }

    .magnifier-circle {
      position: fixed;
      width: 150px;
      height: 150px;
      border: 3px solid #FF5716;
      border-radius: 50%;
      background: transparent;
      pointer-events: none;
      z-index: 100;
      transform: translate(-50%, -50%);
      display: none;
    }

    .magnifier-circle::before {
      content: '';
      position: absolute;
      width: 3px;
      height: 50px;
      background: #FF5716;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .magnifier-circle::after {
      content: '';
      position: absolute;
      width: 50px;
      height: 3px;
      background: #FF5716;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    /* DEFECT EMOJI ON CANVAS */
    .defect-emoji {
      position: absolute;
      font-size: 1.8rem;
      pointer-events: none;
      animation: popDefect 0.4s ease-out forwards;
      cursor: default;
    }

    @keyframes popDefect {
      0% { transform: scale(0) rotate(0deg); opacity: 1; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }

    /* PRODUCT STATUS ZONE */
    .product-status {
      background: rgba(0, 168, 233, 0.15);
      border: 2px solid #00A8E9;
      border-radius: 8px;
      padding: 10px 20px;
      text-align: center;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      width: 90%;
      max-width: 500px;
    }

    .status-message {
      font-size: 1.1rem;
      font-weight: bold;
      color: #ccc;
    }

    .status-score {
      font-size: 1.3rem;
      font-weight: bold;
      margin-top: 5px;
    }

    .status-score.good { color: #10B981; }
    .status-score.bad { color: #EF4444; }

    .feedback-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 50px 80px;
      border-radius: 20px;
      font-size: 2.2rem;
      font-weight: bold;
      text-align: center;
      display: none;
      z-index: 300;
      animation: feedbackAnim 3s ease-in-out;
      box-shadow: 0 0 100px rgba(0,0,0,0.95), inset 0 0 40px rgba(0,0,0,0.5);
      border: 4px solid;
      letter-spacing: 2px;
    }

    .feedback-message.good {
      background: linear-gradient(135deg, #10B981, #059669, #047857);
      border-color: #10B981;
      color: white;
      text-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
    }

    .feedback-message.bad {
      background: linear-gradient(135deg, #EF4444, #DC2626, #991B1B);
      border-color: #EF4444;
      color: white;
      text-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
    }

    .feedback-message.combo {
      background: linear-gradient(135deg, #FF5716, #D97706, #B45309);
      border-color: #FF5716;
      color: white;
      text-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
    }

    @keyframes feedbackAnim {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      10% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
      90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    }

    .right-panel {
      background: #1a1f2e;
      border-left: 1px solid #EF4444;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
    }

    .right-panel h3 { color: #EF4444; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 2px; border-bottom: 1px solid #EF4444; padding-bottom: 2px; }
    .defects-list { flex: 1; display: flex; flex-direction: column; gap: 3px; overflow-y: auto; }
    .defect-item { background: rgba(239, 68, 68, 0.1); padding: 5px; border-radius: 3px; border-left: 2px solid #EF4444; font-size: 0.7rem; animation: slideIn 0.3s ease-out; }
    .defect-name { color: #FF5716; font-weight: bold; margin-bottom: 1px; }
    .defect-severity { color: #999; font-size: 0.6rem; }
    .no-defects { color: #666; text-align: center; padding: 15px 0; font-style: italic; font-size: 0.7rem; }

    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

    .quit-btn { background: linear-gradient(135deg, #666 0%, #444 100%); color: white; padding: 10px 8px; border: 1px solid #444; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; }
    .quit-btn:hover { transform: translateY(-2px); }

    .buttons-panel { display: flex; flex-direction: column; gap: 5px; }
    .btn { padding: 12px 8px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.85rem; transition: all 0.2s; text-transform: uppercase; }
    .btn.reject { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); color: white; border: 1px solid #DC2626; }
    .btn.reject:hover { transform: translateY(-2px); }
    .btn.approve { background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; border: 1px solid #059669; }
    .btn.approve:hover { transform: translateY(-2px); }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    .modal-overlay.hidden { display: none; }

    .modal {
      background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
      border: 2px solid #00A8E9;
      border-radius: 12px;
      padding: 40px;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal h1 { color: #00A8E9; margin-bottom: 20px; font-size: 1.8rem; }
    .modal p { color: #ccc; line-height: 1.6; margin-bottom: 16px; }

    .lang-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 24px 0; }
    .lang-btn { padding: 16px; border: 2px solid #00A8E9; background: transparent; color: #00A8E9; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
    .lang-btn:hover { background: rgba(0, 168, 233, 0.2); transform: scale(1.05); }

    .btn-primary {
      background: linear-gradient(135deg, #00A8E9, #009bcf);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1rem;
      width: 100%;
      margin-top: 16px;
    }

    .btn-primary:hover { transform: translateY(-2px); }

    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #00A8E9;
      background: #0f1419;
      color: white;
      border-radius: 6px;
      font-size: 1rem;
      margin-bottom: 16px;
      font-family: 'Courier New', monospace;
    }

    input:focus { outline: none; box-shadow: 0 0 0 3px rgba(0, 168, 233, 0.3); }

    .rank-timeline {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin: 30px 0;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
    }

    .rank-node {
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      border: 2px solid #333;
      background: rgba(255, 255, 255, 0.05);
    }

    .rank-node.e { border-color: #EF4444; background: rgba(239, 68, 68, 0.1); }
    .rank-node.d { border-color: #00A8E9; background: rgba(0, 168, 233, 0.1); }
    .rank-node.c { border-color: #10B981; background: rgba(16, 185, 129, 0.1); }
    .rank-node.b { border-color: #FF5716; background: rgba(245, 158, 11, 0.1); }
    .rank-node.a { border-color: #FF6B00; background: rgba(255, 107, 0, 0.1); }
    .rank-node.s { border-color: #FFD700; background: rgba(255, 215, 0, 0.1); }

    .rank-node.active {
      box-shadow: 0 0 20px currentColor;
      transform: scale(1.15);
      border-color: currentColor;
    }

    .rank-node.active.e { color: #EF4444; }
    .rank-node.active.d { color: #00A8E9; }
    .rank-node.active.c { color: #10B981; }
    .rank-node.active.b { color: #FF5716; }
    .rank-node.active.a { color: #FF6B00; }
    .rank-node.active.s { color: #FFD700; }

    .rank-letter { font-size: 2rem; font-weight: bold; }
    .rank-name { font-size: 0.7rem; color: #999; margin-top: 4px; }

    .performance-message {
      background: rgba(0, 168, 233, 0.15);
      border: 2px solid #00A8E9;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      font-size: 1.1rem;
      color: #ccc;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .performance-emoji { font-size: 2.5rem; margin-bottom: 10px; }

    .leaderboard-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    .leaderboard-table th, .leaderboard-table td { padding: 12px; text-align: left; border-bottom: 1px solid #333; color: #ccc; }
    .leaderboard-table th { background: #0254A0; color: white; }
    .leaderboard-table tr:hover { background: rgba(0, 168, 233, 0.1); }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
      background: rgba(0, 168, 233, 0.1);
      padding: 15px;
      border-radius: 8px;
    }

    .stat-box { text-align: center; }
    .stat-box-label { font-size: 0.85rem; color: #999; text-transform: uppercase; margin-bottom: 8px; }
    .stat-box-value { font-size: 1.5rem; font-weight: bold; color: #10B981; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f1419; }
    ::-webkit-scrollbar-thumb { background: #00A8E9; border-radius: 3px; }
  </style>
</head>
<body>
  <!-- ZONE DE DETECTION -->
  <div class="inspection-zone" id="inspectionZone"></div>
  <div class="magnifier-circle" id="magnifier"></div>

  <!-- FEEDBACK MESSAGE -->
  <div class="feedback-message" id="feedbackMessage"></div>

  <!-- INTRO SCREEN - Shown immediately (English only) -->
  <div id="introScreen" class="modal-overlay">
    <div class="modal">
      <h1>üîç QUALITY INSPECTOR</h1>
      <p>You are a quality inspector for EDF. You have <strong>5 minutes</strong> to inspect as many products as possible.</p>
      <p><strong>How to play:</strong></p>
      <p>1. <strong>Move the magnifier over the product</strong></p>
      <p>2. <strong>Defects will reveal with emojis</strong> when your zone passes over them</p>
      <p>3. Make your decision: <strong>APPROVE or REJECT</strong></p>
      <p>4. Get 5-combo for +50 bonus points!</p>
      <button class="btn-primary" onclick="startGame()">START GAME ‚Üí</button>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div id="gameScreen" class="modal-overlay hidden" style="background: none; align-items: stretch; justify-content: stretch; inset: 0; position: fixed; flex-direction: column;">
    <div class="header">
      <div class="header-left">
        <h1>‚ö° QUALITY INSPECTOR</h1>
      </div>
      <div class="header-right">
        <p>EDF POWER - Quality Week 2025</p>
      </div>
    </div>

    <div class="timer-bar-full">
      <div class="timer-display" id="timeDisplay">5:00</div>
      <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-label">Produits</div>
        <div class="stat-val" id="statsProducts">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Bons</div>
        <div class="stat-val" id="statsGood" style="color: #10B981;">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Taux Qual.</div>
        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
          <div class="stat-val warning" id="statsQuality">--%</div>
          <span id="qualitySmiley" style="font-size: 1.2rem;">üòê</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Mauvais</div>
        <div class="stat-val danger" id="statsBad">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Combo</div>
        <div class="stat-val" id="statsCombo" style="color: #00A8E9;">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Score</div>
        <div class="stat-val" id="statsScore" style="color: #10B981;">0</div>
      </div>
    </div>

    <div class="main-container">
      <div class="left-panel">
        <h3>üì¶ QUEUE</h3>
        <div class="queue-items" id="queueContainer"></div>
      </div>

      <div class="center-area">
        <div class="canvas-container">
          <canvas id="productCanvas"></canvas>
        </div>
        <div class="product-status">
          <div class="status-message" id="statusMessage">Scan the product...</div>
          <div class="status-score" id="statusScore"></div>
        </div>
      </div>

      <div class="right-panel">
        <button class="quit-btn" onclick="endGame()">QUIT JOB</button>
        <h3>‚ö†Ô∏è DEFECTS</h3>
        <div class="defects-list" id="defectsList">
          <div class="no-defects">No defects yet...</div>
        </div>
        <div class="buttons-panel">
          <button class="btn reject" onclick="makeDecision('reject')">‚úó REJECT</button>
          <button class="btn approve" onclick="makeDecision('good')">‚úì APPROVE</button>
        </div>
      </div>
    </div>
  </div>

  <!-- END SCREEN -->
  <div id="endGameScreen" class="modal-overlay hidden">
    <div class="modal" style="max-width: 700px; max-height: 95vh;">
      <p style="text-align: center; color: #00A8E9; font-size: 1.3rem; font-weight: bold; margin-bottom: 20px;" id="finalName"></p>
      
      <h1 style="text-align: center; margin-bottom: 30px;">üìä INSPECTION COMPLETE</h1>

      <div class="rank-timeline">
        <div class="rank-node e"><div class="rank-letter">E</div><div class="rank-name">Eeewww</div></div>
        <div class="rank-node d"><div class="rank-letter">D</div><div class="rank-name">Decent</div></div>
        <div class="rank-node c"><div class="rank-letter">C</div><div class="rank-name">Competent</div></div>
        <div class="rank-node b"><div class="rank-letter">B</div><div class="rank-name">Brilliant</div></div>
        <div class="rank-node a"><div class="rank-letter">A</div><div class="rank-name">Awesome</div></div>
        <div class="rank-node s"><div class="rank-letter">S</div><div class="rank-name">Splendid</div></div>
      </div>

      <div class="performance-message">
        <div class="performance-emoji" id="performanceEmoji">üéØ</div>
        <div id="performanceText"></div>
      </div>

      <div class="stats-grid">
        <div class="stat-box" style="grid-column: 1 / -1; background: rgba(0, 168, 233, 0.2); padding: 20px; border-radius: 8px;">
          <div class="stat-box-label">FINAL SCORE</div>
          <div style="font-size: 3rem; font-weight: bold; color: #10B981; text-shadow: 0 0 20px rgba(16, 185, 129, 0.8);" id="finalScore">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Player Ratio</div>
          <div class="stat-box-value" id="finalRatio">0/0 = 0%</div>
        </div>
        <div class="stat-box" style="background: rgba(245, 158, 11, 0.15); padding: 15px; border-radius: 8px;">
          <div class="stat-box-label">üî• MAX COMBO</div>
          <div style="font-size: 2rem; font-weight: bold; color: #FF5716; text-shadow: 0 0 15px rgba(245, 158, 11, 0.8);" id="maxComboDisplay">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Avg Time/Product</div>
          <div class="stat-box-value" id="avgTime">0s</div>
        </div>
      </div>

      <p>Enter your name:</p>
      <input type="text" id="playerNameInput" placeholder="Your name" maxlength="30">
      <button class="btn-primary" onclick="submitScore()">SUBMIT ‚Üí</button>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboardScreen" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
      <h1 style="margin-bottom: 20px;">üèÜ LEADERBOARD - TOP 20</h1>
      <table class="leaderboard-table" style="flex: 1; overflow-y: auto; max-height: 500px;">
        <thead style="position: sticky; top: 0; background: #0254A0;">
          <tr>
            <th>#</th>
            <th>NAME</th>
            <th>SCORE</th>
            <th>RATIO</th>
            <th>AVG TIME</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
      <button class="btn-primary" style="margin-top: 20px;" onclick="showIntroScreen()">PLAY AGAIN</button>
    </div>
  </div>

  <!-- INTRO SCREEN PARC D'ATTRACTIONS -->
  <div id="introScreenAnimated" style="position: fixed; inset: 0; background: linear-gradient(135deg, #0254A0 0%, #00A8E9 100%); display: none; z-index: 2000; align-items: center; justify-content: center; flex-direction: column; padding: 40px; overflow-y: auto;">
    <style>
      @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
      @keyframes slideLeft { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
      @keyframes slideRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
      @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes pulse { 0%, 100% { box-shadow: 0 10px 40px rgba(255,87,22,0.4); transform: scale(1); } 50% { box-shadow: 0 15px 60px rgba(255,87,22,0.7); transform: scale(1.05); } }
      @keyframes firework { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
      .firework { position: absolute; width: 10px; height: 10px; border-radius: 50%; pointer-events: none; }
      @media (max-width: 1024px) {
        #introScreenAnimated > div:first-of-type { flex-direction: column !important; gap: 20px !important; }
        #introScreenAnimated > div:first-of-type > div:nth-child(2) { display: none; }
      }
    </style>
    
    <h1 style="font-size: 4rem; font-weight: 900; color: white; text-shadow: 0 0 20px rgba(255,255,255,0.3); margin-bottom: 30px; animation: bounce 2s infinite;">‚ö° QUALITY INSPECTOR</h1>
    
    <div style="display: flex; gap: 40px; width: 100%; max-width: 1400px; min-height: 500px;">
      <div style="flex: 1; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; overflow-y: auto; animation: slideLeft 0.8s ease-out;">
        <h2 style="font-size: 2rem; color: #0254A0; margin-bottom: 20px; cursor: pointer; user-select: none;" id="rulesTrigger">üìã HOW TO PLAY</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div style="background: rgba(2,84,160,0.1); border: 2px solid #0254A0; border-radius: 10px; padding: 15px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 5px;">üîç</div><strong style="color: #0254A0;">SCAN</strong><p style="color: #666; font-size: 0.9rem;">Move magnifier over product</p></div>
          <div style="background: rgba(2,84,160,0.1); border: 2px solid #0254A0; border-radius: 10px; padding: 15px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 5px;">‚ö†Ô∏è</div><strong style="color: #0254A0;">FIND</strong><p style="color: #666; font-size: 0.9rem;">Find defects that appear</p></div>
          <div style="background: rgba(2,84,160,0.1); border: 2px solid #0254A0; border-radius: 10px; padding: 15px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 5px;">‚úÖ</div><strong style="color: #0254A0;">DECIDE</strong><p style="color: #666; font-size: 0.9rem;">Approve or reject</p></div>
          <div style="background: rgba(2,84,160,0.1); border: 2px solid #0254A0; border-radius: 10px; padding: 15px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 5px;">üî•</div><strong style="color: #0254A0;">COMBO</strong><p style="color: #666; font-size: 0.9rem;">5 correct = +50 pts</p></div>
          <div style="background: rgba(2,84,160,0.1); border: 2px solid #0254A0; border-radius: 10px; padding: 15px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 5px;">‚è±Ô∏è</div><strong style="color: #0254A0;">TIME</strong><p style="color: #666; font-size: 0.9rem;">2 minutes challenge</p></div>
          <div style="background: rgba(2,84,160,0.1); border: 2px solid #0254A0; border-radius: 10px; padding: 15px; text-align: center;"><div style="font-size: 2rem; margin-bottom: 5px;">üí∞</div><strong style="color: #0254A0;">EARN</strong><p style="color: #666; font-size: 0.9rem;">Good = money, bad = loss</p></div>
        </div>
      </div>
      <div style="width: 3px; background: linear-gradient(180deg, transparent 0%, white 50%, transparent 100%); border-radius: 10px;"></div>
      <div style="flex: 1; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; overflow-y: auto; animation: slideRight 0.8s ease-out;">
        <h2 style="font-size: 2rem; color: #FF5716; margin-bottom: 20px; cursor: pointer; user-select: none;" id="leaderboardTitle">üèÜ HALL OF FAME</h2>
        <div id="introLeaderboardList" style="display: flex; flex-direction: column; gap: 10px;">
          <div style="text-align: center; color: #999;"><p>‚≠ê No scores yet!</p><p>Be the first!</p></div>
        </div>
      </div>
    </div>
    <button onclick="startGame()" style="margin-top: 30px; padding: 20px 60px; font-size: 1.5rem; font-weight: 900; color: white; background: linear-gradient(135deg, #FF5716 0%, #E84E0F 100%); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 40px rgba(255,87,22,0.4); animation: pulse 2s infinite; text-transform: uppercase; letter-spacing: 2px;">‚ñ∂ START GAME</button>
  </div>

  <!-- EASTER EGG -->
  <div id="easterOverlay" style="position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 9999; align-items: center; justify-content: center; flex-direction: column;">
    <div style="position: relative; display: flex; align-items: center; justify-content: center;">
      <img src="easter.jpg" style="max-width: 80%; max-height: 70%; border: 3px solid #FF5716; border-radius: 10px; position: relative; z-index: 1;">
      <div id="fireworksContainer" style="position: absolute; width: 100%; height: 100%; pointer-events: none;"></div>
    </div>
    <div style="font-size: 1.5rem; font-weight: bold; color: #FF5716; text-align: center; margin-top: 20px;">Made with Love ‚ô• Quali-Team</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ‚ö†Ô∏è √Ä CONFIGURER AVEC TES CREDENTIALS
    const SUPABASE_URL = 'https://tqwrsakylbyqmxwyhoar.supabase.co'; // Remplace par ton URL
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxd3JzYWt5bGJ5cW14d3lob2FyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjE4NTUsImV4cCI6MjA3NjYzNzg1NX0.WIo9YUtJnxfgsZmnPluGexBAztB7dJG6uYKnNe7o_6A'; // Remplace par ta cl√© publique
  
    
    // Initialise Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // ‚ö†Ô∏è D√©finir TOUTES les fonctions globales AVANT les donn√©es
    window.setLanguage = function(lang) {
      currentLanguage = lang;
      localStorage.setItem('gameLanguage', lang);
      showScreen('introScreen');
    };
    
    window.startGame = function() {
      const introScreen = document.getElementById('introScreenAnimated');
      if (introScreen) introScreen.style.display = 'none';
      
      gameActive = true;
      gameStartTime = Date.now();
      correctCombo = 0;
      gameStats = { productsInspected: 0, productsGood: 0, productsBad: 0, totalScore: 0, quality: 0, maxCombo: 0, totalInspectionTime: 0 };
      generateProducts();
      showScreen('gameScreen');
      loadNextProduct();
      startGameLoop();
    };
    
    window.makeDecision = function(decision) {
      if (!gameActive) return;
      const hasDefects = foundDefects.length > 0;
      let isCorrect = false;
      if (decision === 'good') isCorrect = !hasDefects;
      else if (decision === 'reject') isCorrect = hasDefects;

      gameStats.productsInspected++;
      const productTime = (Date.now() - productStartTime) / 1000;
      gameStats.totalInspectionTime += productTime;
      
      let scoreChange = 0;
      let feedbackMsg = '';
      let statusMsg = '';
      
      if (isCorrect) {
        correctCombo++;
        if (correctCombo > gameStats.maxCombo) gameStats.maxCombo = correctCombo;
        
        if (decision === 'good') {
          gameStats.productsGood++;
          scoreChange = currentProduct.value;
          gameStats.totalScore += scoreChange;
          feedbackMsg = `‚úÖ CORRECT! +${scoreChange} pts`;
          statusMsg = currentLanguage === 'fr' ? `‚úÖ Bien jou√©! +${scoreChange}` : `‚úÖ Well done! +${scoreChange}`;
        } else {
          gameStats.productsBad++;
          scoreChange = currentProduct.value;
          gameStats.totalScore += scoreChange;
          feedbackMsg = `‚úÖ CORRECT! +${scoreChange} pts`;
          statusMsg = currentLanguage === 'fr' ? `‚úÖ Bien jou√©! +${scoreChange}` : `‚úÖ Well done! +${scoreChange}`;
        }

        if (correctCombo === 5) {
          gameStats.totalScore += 50;
          correctCombo = 0;
          feedbackMsg = 'üî• COMBO x5! +50 PTS!';
          statusMsg = 'üî• COMBO x5! +50';
          showFeedback(feedbackMsg, true);
        } else {
          showFeedback(feedbackMsg, true);
        }
      } else {
        correctCombo = 0;
        scoreChange = -50;
        gameStats.totalScore = Math.max(0, gameStats.totalScore + scoreChange);
        feedbackMsg = `‚ùå WRONG! ${scoreChange} pts`;
        statusMsg = currentLanguage === 'fr' ? `‚ùå Arf! ${scoreChange}` : `‚ùå Wrong! ${scoreChange}`;
        showFeedback(feedbackMsg, false);
      }

      document.getElementById('statusMessage').textContent = statusMsg;
      document.getElementById('statusScore').textContent = '';

      currentProductIndex++;
      setTimeout(() => loadNextProduct(), 800);
    };
    
    window.endGame = function() {
      gameActive = false;
      mouseOverCanvas = false;
      document.getElementById('magnifier').style.display = 'none';
      document.getElementById('inspectionZone').style.display = 'none';

      const rank = getRankInfo(gameStats.totalScore, gameStats.quality, gameStats.maxCombo);
      const rankMessages = RANK_MESSAGES[currentLanguage][rank.letter];
      const randomMessage = rankMessages.messages[Math.floor(Math.random() * rankMessages.messages.length)];
      const avgTime = gameStats.productsInspected > 0 ? (gameStats.totalInspectionTime / gameStats.productsInspected).toFixed(1) : 0;

      document.querySelectorAll('.rank-node').forEach(node => node.classList.remove('active'));
      document.querySelector(`.rank-node.${rank.code}`).classList.add('active');

      document.getElementById('performanceEmoji').textContent = rankMessages.emoji;
      document.getElementById('performanceText').innerHTML = `<strong style="font-size: 1.3rem; color: #00A8E9;">${randomMessage}</strong>`;

      document.getElementById('finalName').textContent = '';
      document.getElementById('finalRatio').textContent = `${gameStats.productsGood}/${gameStats.productsInspected} = ${gameStats.quality}%`;
      document.getElementById('finalScore').textContent = gameStats.totalScore;
      document.getElementById('avgTime').textContent = avgTime + 's';
      document.getElementById('maxComboDisplay').textContent = gameStats.maxCombo;

      showScreen('endGameScreen');
    };
    
    window.submitScore = async function() {
      const name = document.getElementById('playerNameInput').value.trim();
      if (!name) { alert('Enter a name!'); return; }
      
      document.getElementById('finalName').textContent = `üèÜ ${name}`;
      
      const avgTime = gameStats.productsInspected > 0 ? (gameStats.totalInspectionTime / gameStats.productsInspected).toFixed(1) : 0;
      
      const newScore = {
        name: name, 
        score: gameStats.totalScore, 
        good_count: gameStats.productsGood,
        total_count: gameStats.productsInspected,
        quality: gameStats.quality,
        avg_time: parseFloat(avgTime)
      };
      
      try {
        if (supabase && SUPABASE_URL !== 'https://xxxxx.supabase.co') {
          const { data, error } = await supabase
            .from('scores')
            .insert([newScore]);
          
          if (error) {
            console.error('Supabase error:', error);
            saveToLocalStorage(newScore);
          } else {
            console.log('‚úÖ Score saved to cloud!');
          }
        } else {
          console.log('‚ö†Ô∏è Supabase not configured, using localStorage');
          saveToLocalStorage(newScore);
        }
      } catch (err) {
        console.error('Error:', err);
        saveToLocalStorage(newScore);
      }
      
      showLeaderboard();
    };
    
    const PRODUCTS_DATA = {
      fr: [
        { name: 'Pale', id: 'blade', value: 150, emoji: 'ü™®' },
        { name: 'Tour', id: 'tower', value: 200, emoji: 'üóº' },
        { name: 'Nacelle', id: 'nacelle', value: 180, emoji: '‚öôÔ∏è' },
        { name: 'MonoPile', id: 'monopile', value: 250, emoji: 'üìç' },
        { name: 'Transition', id: 'transition', value: 160, emoji: 'üîó' },
        { name: 'Cables', id: 'cables', value: 140, emoji: 'üîå' },
        { name: 'Topside', id: 'topside', value: 220, emoji: 'üèóÔ∏è' },
        { name: 'SubStation', id: 'substation', value: 300, emoji: 'üì¶' },
        { name: 'Jacket', id: 'jacket', value: 190, emoji: 'üî≤' },
        { name: 'Connecteur', id: 'connector', value: 120, emoji: 'üîß' },
        { name: 'Plaque Base', id: 'baseplate', value: 140, emoji: 'üõë' },
        { name: 'Amortisseur', id: 'damper', value: 175, emoji: 'üåÄ' },
        { name: 'Valve', id: 'valve', value: 95, emoji: 'üö∞' },
        { name: 'Roulement', id: 'bearing', value: 110, emoji: '‚≠ï' },
        { name: 'Poulies', id: 'pulleys', value: 130, emoji: '‚ö°' }
      ],
      en: [
        { name: 'Blade', id: 'blade', value: 150, emoji: 'ü™®' },
        { name: 'Tower', id: 'tower', value: 200, emoji: 'üóº' },
        { name: 'Nacelle', id: 'nacelle', value: 180, emoji: '‚öôÔ∏è' },
        { name: 'MonoPile', id: 'monopile', value: 250, emoji: 'üìç' },
        { name: 'Transition', id: 'transition', value: 160, emoji: 'üîó' },
        { name: 'Cables', id: 'cables', value: 140, emoji: 'üîå' },
        { name: 'Topside', id: 'topside', value: 220, emoji: 'üèóÔ∏è' },
        { name: 'Substation', id: 'substation', value: 300, emoji: 'üì¶' },
        { name: 'Jacket', id: 'jacket', value: 190, emoji: 'üî≤' },
        { name: 'Connector', id: 'connector', value: 120, emoji: 'üîß' },
        { name: 'Base Plate', id: 'baseplate', value: 140, emoji: 'üõë' },
        { name: 'Damper', id: 'damper', value: 175, emoji: 'üåÄ' },
        { name: 'Valve', id: 'valve', value: 95, emoji: 'üö∞' },
        { name: 'Bearing', id: 'bearing', value: 110, emoji: '‚≠ï' },
        { name: 'Pulleys', id: 'pulleys', value: 130, emoji: '‚ö°' }
      ]
    };

    const DEFECT_TYPES = {
      fr: [
        { name: 'Rayure', severity: 'minor', cost: 20, emoji: 'üî¥' },
        { name: 'Corrosion', severity: 'major', cost: 80, emoji: '‚ö´' },
        { name: 'Fissure', severity: 'major', cost: 100, emoji: 'üíî' },
        { name: 'Usure', severity: 'medium', cost: 50, emoji: 'üëª' },
        { name: 'D√©salignement', severity: 'medium', cost: 60, emoji: '‚ùå' },
        { name: 'Fuite', severity: 'major', cost: 90, emoji: 'üíß' }
      ],
      en: [
        { name: 'Scratch', severity: 'minor', cost: 20, emoji: 'üî¥' },
        { name: 'Corrosion', severity: 'major', cost: 80, emoji: '‚ö´' },
        { name: 'Crack', severity: 'major', cost: 100, emoji: 'üíî' },
        { name: 'Wear', severity: 'medium', cost: 50, emoji: 'üëª' },
        { name: 'Misalignment', severity: 'medium', cost: 60, emoji: '‚ùå' },
        { name: 'Leak', severity: 'major', cost: 90, emoji: 'üíß' }
      ]
    };

    const RANK_MESSAGES = {
      fr: {
        E: { emoji: 'üòÖ', messages: ['Euh... continue √† pratiquer!', 'Pire que pr√©vu!', 'Pas ta force!', 'Besoin de formation! üìö'] },
        D: { emoji: 'üòê', messages: ['Pas mal pour un d√©but!', 'Tu vas progresser!', 'Decent job!', 'Moyen, vraiment moyen...'] },
        C: { emoji: 'üëç', messages: ['Pas mal du tout!', 'Tu progresses bien!', 'C\'est competent!', 'Correcte inspecteur!'] },
        B: { emoji: 'üòä', messages: ['Brilliant travail!', 'Tu as bon ≈ìil!', 'Vraiment bon!', 'On voit le potentiel!'] },
        A: { emoji: 'ü§©', messages: ['Awesome! You\'ve got the eye! You should apply to be part of inspection team! üòé', 'Incroyable! Tu devrais √™tre formateur! üëç', 'Magnifique inspection! üåü', 'Tu as √©t√© awesome!'] },
        S: { emoji: 'üëë', messages: ['SPLENDID! C\'est PARFAIT! üèÜ', 'T\'es un legend! üöÄ', 'Incroyable! Perfection! üíé', 'Vous √™tes un inspecteur d\'√©lite! üëë'] }
      },
      en: {
        E: { emoji: 'üòÖ', messages: ['Ehhh... keep practicing!', 'Worse than expected!', 'That\'s not your strength!', 'Need some training! üìö'] },
        D: { emoji: 'üòê', messages: ['Not bad for a start!', 'You\'ll get better!', 'Decent job!', 'Really just okay...'] },
        C: { emoji: 'üëç', messages: ['Pretty good!', 'You\'re improving!', 'That\'s competent!', 'Good job, inspector!'] },
        B: { emoji: 'üòä', messages: ['Brilliant work!', 'You\'ve got a good eye!', 'Really good!', 'We see the potential!'] },
        A: { emoji: 'ü§©', messages: ['Awesome! You\'ve got the eye! You should apply to be part of inspection team! üòé', 'Incredible! You should be a trainer! üëç', 'Magnificent inspection! üåü', 'You were awesome!'] },
        S: { emoji: 'üëë', messages: ['SPLENDID! It\'s PERFECT! üèÜ', 'You\'re a legend! üöÄ', 'Amazing! Perfection! üíé', 'You\'re an elite inspector! üëë'] }
      }
    };

    let currentLanguage = 'en';
    let gameActive = false;
    let gameStartTime = 0;
    let currentProduct = null;
    let currentDefects = [];
    let defectPositions = [];
    let foundDefects = [];
    let allProducts = [];
    let currentProductIndex = 0;
    let mouseOverCanvas = false;
    let correctCombo = 0;
    let productStartTime = 0;

    let gameStats = {
      productsInspected: 0,
      productsGood: 0,
      productsBad: 0,
      totalScore: 0,
      quality: 0,
      maxCombo: 0,
      totalInspectionTime: 0
    };

    function generateProducts() {
      const productList = PRODUCTS_DATA[currentLanguage];
      allProducts = [];
      for (let i = 0; i < 30; i++) {
        const product = productList[Math.floor(Math.random() * productList.length)];
        allProducts.push({ ...product, defects: [] });
      }
    }

    function loadNextProduct() {
      if (currentProductIndex >= allProducts.length || !gameActive) {
        endGame();
        return;
      }

      currentProduct = allProducts[currentProductIndex];
      currentDefects = [];
      foundDefects = [];
      defectPositions = [];
      revealedEmojis = []; // RESET emojis
      productStartTime = Date.now();

      document.getElementById('statusMessage').textContent = currentLanguage === 'fr' ? 'Scannez le produit...' : 'Scan the product...';
      document.getElementById('statusScore').textContent = '';

      const defectList = DEFECT_TYPES[currentLanguage];
      if (Math.random() < 0.45) {
        const defectCount = Math.random() < 0.6 ? 1 : 2;
        for (let i = 0; i < defectCount; i++) {
          const defect = defectList[Math.floor(Math.random() * defectList.length)];
          currentDefects.push({ ...defect });
          // Position al√©atoire STRICTEMENT dans le carr√© gris (30px √† 370px en X et Y)
          defectPositions.push({
            x: (Math.random() * 0.6 + 0.2), // Entre 20% et 80%
            y: (Math.random() * 0.6 + 0.15), // Entre 15% et 75%
            defect: defect,
            found: false
          });
        }
      }

      currentProduct.defects = [...currentDefects];
      drawProductArt(currentProduct.id);
      updateQueue();
      updateDefectsList();
    }

    function updateDefectsList() {
      const container = document.getElementById('defectsList');
      if (foundDefects.length === 0) {
        container.innerHTML = '<div class="no-defects">No defects yet...</div>';
        return;
      }
      const html = foundDefects.map(d => `
        <div class="defect-item">
          <div class="defect-name">${d.emoji} ${d.name}</div>
          <div class="defect-severity">[${d.severity.toUpperCase()}]</div>
        </div>
      `).join('');
      container.innerHTML = html;
    }

    function updateQueue() {
      const container = document.getElementById('queueContainer');
      container.innerHTML = '';
      for (let i = currentProductIndex; i < allProducts.length; i++) {
        const product = allProducts[i];
        const item = document.createElement('div');
        item.className = 'queue-item' + (i === currentProductIndex ? ' active' : '');
        item.textContent = `${product.emoji} ${product.name}`;
        container.appendChild(item);
      }
    }

    const canvas = document.getElementById('productCanvas');

    canvas.addEventListener('mouseenter', () => {
      mouseOverCanvas = true;
      document.getElementById('magnifier').style.display = 'block';
      document.getElementById('inspectionZone').style.display = 'block';
    });

    canvas.addEventListener('mouseleave', () => {
      mouseOverCanvas = false;
      document.getElementById('magnifier').style.display = 'none';
      document.getElementById('inspectionZone').style.display = 'none';
    });

    let lastMouseX = 0;
    let lastMouseY = 0;
    let isTouching = false;

    function handleMouseMove(e) {
      lastMouseX = e.clientX;
      lastMouseY = e.clientY;

      // SIMPLE: souris/doigt sur canvas = check defects
      const canvasRect = canvas.getBoundingClientRect();
      
      // Position relative sur le canvas (0 √† 1)
      const relX = (e.clientX - canvasRect.left) / canvasRect.width;
      const relY = (e.clientY - canvasRect.top) / canvasRect.height;
      
      // Check si on est sur le canvas
      if (relX < 0 || relX > 1 || relY < 0 || relY > 1) return;
      
      // Redessine tout avec la zone
      redrawCanvas();
      drawZoneAround(relX, relY);
      drawAllEmojis();
      
      // Check each defect position
      defectPositions.forEach((def, idx) => {
        if (def.found) return;
        
        // Distance entre souris et d√©faut (en % du canvas)
        const dist = Math.sqrt(Math.pow(relX - def.x, 2) + Math.pow(relY - def.y, 2));
        
        // Si proche (0.08 = 8% du canvas au lieu de 15%)
        if (dist < 0.08) {
          def.found = true;
          foundDefects.push(def.defect);
          
          // DESSINE emoji directement sur le canvas
          drawEmojiOnCanvas(def.x, def.y, def.defect.emoji);
          
          updateDefectsList();
        }
      });
    }

    // SOURIS - Desktop
    canvas.addEventListener('mousemove', handleMouseMove);

    // TOUCH - Mobile (doigt appuy√©)
    canvas.addEventListener('touchstart', (e) => {
      isTouching = true;
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      handleMouseMove(mouseEvent);
    }, { passive: true });

    canvas.addEventListener('touchmove', (e) => {
      if (!isTouching) return;
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      handleMouseMove(mouseEvent);
    }, { passive: false });

    canvas.addEventListener('touchend', () => {
      isTouching = false;
      // Redessine sans la zone apr√®s rel√¢chement
      redrawCanvas();
      drawAllEmojis();
    }, { passive: true });

    function drawZoneAround(relX, relY) {
      const ctx = canvas.getContext('2d');
      const x = relX * canvas.width;
      const y = relY * canvas.height;
      const radius = 25;
      
      // Glow ext√©rieur violet
      ctx.shadowColor = 'rgba(168, 85, 247, 0.8)';
      ctx.shadowBlur = 30;
      
      // Cercle principal violet
      ctx.strokeStyle = '#A855F7';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, Math.PI * 2);
      ctx.stroke();
      
      // Cercle int√©rieur (doubl√© pour plus d'√©paisseur)
      ctx.strokeStyle = '#D8B4FE';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.arc(x, y, radius - 2, 0, Math.PI * 2);
      ctx.stroke();
      
      // Glow int√©rieur subtle
      ctx.shadowColor = 'rgba(168, 85, 247, 0.5)';
      ctx.shadowBlur = 15;
      ctx.fillStyle = 'rgba(168, 85, 247, 0.08)';
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, Math.PI * 2);
      ctx.fill();
      
      // Crosshair violet
      ctx.shadowColor = 'rgba(168, 85, 247, 0.8)';
      ctx.shadowBlur = 10;
      ctx.strokeStyle = '#D8B4FE';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x - 12, y);
      ctx.lineTo(x + 12, y);
      ctx.moveTo(x, y - 12);
      ctx.lineTo(x, y + 12);
      ctx.stroke();
      
      // Reset shadow
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
    }

    let revealedEmojis = []; // Stocke les emojis r√©v√©l√©s

    function drawEmojiOnCanvas(relX, relY, emoji) {
      const ctx = canvas.getContext('2d');
      const x = relX * canvas.width;
      const y = relY * canvas.height;
      
      // Stock l'emoji r√©v√©l√©
      revealedEmojis.push({ x, y, emoji });
      
      // Dessine une premi√®re fois
      drawAllEmojis();
    }

    function drawAllEmojis() {
      const ctx = canvas.getContext('2d');
      
      revealedEmojis.forEach(item => {
        // Fond circulaire jaune - PLUS PETIT
        ctx.fillStyle = 'rgba(255, 215, 0, 0.9)';
        ctx.beginPath();
        ctx.arc(item.x, item.y, 20, 0, Math.PI * 2); // R√©duit de 35 √† 20
        ctx.fill();
        
        // Bordure
        ctx.strokeStyle = '#FF5716';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // Emoji - PLUS PETIT
        ctx.font = 'bold 28px Arial'; // R√©duit de 45px √† 28px
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(item.emoji, item.x, item.y);
      });
    }

    function redrawCanvas() {
      drawProductArt(currentProduct.id);
      drawAllEmojis(); // Redessine aussi les emojis
    }



    window.makeDecision = function(decision) {
      if (!gameActive) return;
      const hasDefects = foundDefects.length > 0;
      let isCorrect = false;
      if (decision === 'good') isCorrect = !hasDefects;
      else if (decision === 'reject') isCorrect = hasDefects;

      gameStats.productsInspected++;
      const productTime = (Date.now() - productStartTime) / 1000;
      gameStats.totalInspectionTime += productTime;
      
      let scoreChange = 0;
      let feedbackMsg = '';
      let statusMsg = '';
      
      if (isCorrect) {
        correctCombo++;
        if (correctCombo > gameStats.maxCombo) gameStats.maxCombo = correctCombo;
        
        if (decision === 'good') {
          gameStats.productsGood++;
          scoreChange = currentProduct.value;
          gameStats.totalScore += scoreChange;
          feedbackMsg = `‚úÖ CORRECT! +${scoreChange} pts`;
          statusMsg = currentLanguage === 'fr' ? `‚úÖ Bien jou√©! +${scoreChange}` : `‚úÖ Well done! +${scoreChange}`;
        } else {
          gameStats.productsBad++;
          scoreChange = currentProduct.value;
          gameStats.totalScore += scoreChange;
          feedbackMsg = `‚úÖ CORRECT! +${scoreChange} pts`;
          statusMsg = currentLanguage === 'fr' ? `‚úÖ Bien jou√©! +${scoreChange}` : `‚úÖ Well done! +${scoreChange}`;
        }

        if (correctCombo === 5) {
          gameStats.totalScore += 50;
          correctCombo = 0;
          feedbackMsg = 'üî• COMBO x5! +50 PTS!';
          statusMsg = 'üî• COMBO x5! +50';
          showFeedback(feedbackMsg, true);
        } else {
          showFeedback(feedbackMsg, true);
        }
      } else {
        correctCombo = 0;
        scoreChange = -50;
        gameStats.totalScore = Math.max(0, gameStats.totalScore + scoreChange);
        feedbackMsg = `‚ùå WRONG! ${scoreChange} pts`;
        statusMsg = currentLanguage === 'fr' ? `‚ùå Arf! ${scoreChange}` : `‚ùå Wrong! ${scoreChange}`;
        showFeedback(feedbackMsg, false);
      }

      document.getElementById('statusMessage').textContent = statusMsg;
      document.getElementById('statusScore').textContent = '';

      currentProductIndex++;
      setTimeout(() => loadNextProduct(), 800);
    }

    function showFeedback(message, isGood) {
      const feedback = document.getElementById('feedbackMessage');
      feedback.textContent = message;
      feedback.className = isGood ? 'feedback-message good' : 'feedback-message bad';
      feedback.style.display = 'block';
      setTimeout(() => { feedback.style.display = 'none'; }, 3000);
    }

    function updateQualitySmiley() {
      const quality = gameStats.quality;
      let smiley = 'üòê';
      
      if (quality >= 95) smiley = 'üòç';
      else if (quality >= 90) smiley = 'ü§©';
      else if (quality >= 80) smiley = 'üòä';
      else if (quality >= 70) smiley = 'üôÇ';
      else if (quality >= 60) smiley = 'üòê';
      else if (quality >= 50) smiley = 'üòï';
      else if (quality >= 30) smiley = 'üòü';
      else smiley = 'üò¢';
      
      document.getElementById('qualitySmiley').textContent = smiley;
    }

    function drawProductArt(productId) {
      const canvas = document.getElementById('productCanvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = 400;
      canvas.height = 350;

      ctx.fillStyle = '#f5f5f5';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#e8e8e8';
      ctx.fillRect(30, 30, canvas.width - 60, canvas.height - 60);
      ctx.strokeStyle = '#999';
      ctx.lineWidth = 1;
      ctx.strokeRect(30, 30, canvas.width - 60, canvas.height - 60);

      const x = canvas.width / 2;
      const y = canvas.height / 2;

      switch(productId) {
        case 'blade': drawBlade(ctx, x, y); break;
        case 'tower': drawTower(ctx, x, y); break;
        case 'cables': drawCables(ctx, x, y); break;
        case 'monopile': drawMonopile(ctx, x, y); break;
        case 'connector': drawConnector(ctx, x, y); break;
        case 'jacket': drawJacket(ctx, x, y); break;
        default: drawRectangle(ctx, x, y);
      }
    }

    function drawBlade(ctx, x, y) {
      ctx.save();
      ctx.translate(x, y);
      const gradient = ctx.createLinearGradient(-60, -150, 60, 150);
      gradient.addColorStop(0, '#e0e0e0');
      gradient.addColorStop(0.5, '#b8b8b8');
      gradient.addColorStop(1, '#808080');
      ctx.beginPath();
      ctx.moveTo(-50, -150);
      ctx.bezierCurveTo(-80, -100, -100, 0, -50, 150);
      ctx.bezierCurveTo(-20, 160, 20, 160, 50, 150);
      ctx.bezierCurveTo(100, 0, 80, -100, 50, -150);
      ctx.closePath();
      ctx.fillStyle = gradient;
      ctx.fill();
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();
    }

    function drawTower(ctx, x, y) {
      ctx.save();
      ctx.translate(x, y);
      const bodyGrad = ctx.createLinearGradient(-70, -140, 70, 140);
      bodyGrad.addColorStop(0, '#c0c0c0');
      bodyGrad.addColorStop(0.5, '#888888');
      bodyGrad.addColorStop(1, '#555555');
      ctx.fillStyle = bodyGrad;
      ctx.fillRect(-70, -140, 140, 280);
      ctx.strokeStyle = '#222';
      ctx.lineWidth = 2;
      ctx.strokeRect(-70, -140, 140, 280);
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 1;
      for (let i = -100; i < 140; i += 70) {
        ctx.beginPath();
        ctx.moveTo(-70, i);
        ctx.lineTo(70, i);
        ctx.stroke();
      }
      ctx.restore();
    }

    function drawCables(ctx, x, y) {
      ctx.save();
      ctx.translate(x, y);
      ctx.strokeStyle = '#222';
      ctx.lineWidth = 16;
      ctx.beginPath();
      ctx.moveTo(-100, -80);
      ctx.quadraticCurveTo(0, 120, 100, -80);
      ctx.stroke();
      ctx.strokeStyle = '#555';
      ctx.lineWidth = 12;
      ctx.beginPath();
      ctx.moveTo(-100, -80);
      ctx.quadraticCurveTo(0, 120, 100, -80);
      ctx.stroke();
      ctx.restore();
    }

    function drawMonopile(ctx, x, y) {
      ctx.save();
      ctx.translate(x, y);
      const pipeGrad = ctx.createLinearGradient(-80, -140, 80, 140);
      pipeGrad.addColorStop(0, '#d0d0d0');
      pipeGrad.addColorStop(0.5, '#888888');
      pipeGrad.addColorStop(1, '#555555');
      ctx.beginPath();
      ctx.moveTo(-60, -140);
      ctx.lineTo(60, -140);
      ctx.lineTo(90, 140);
      ctx.lineTo(-90, 140);
      ctx.closePath();
      ctx.fillStyle = pipeGrad;
      ctx.fill();
      ctx.strokeStyle = '#222';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();
    }

    function drawConnector(ctx, x, y) {
      ctx.save();
      ctx.translate(x, y);
      const boxGrad = ctx.createLinearGradient(-70, -70, 70, 70);
      boxGrad.addColorStop(0, '#ffdd55');
      boxGrad.addColorStop(0.5, '#ffbb00');
      boxGrad.addColorStop(1, '#ff9900');
      ctx.fillStyle = boxGrad;
      ctx.fillRect(-70, -70, 140, 140);
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      ctx.strokeRect(-70, -70, 140, 140);
      ctx.fillStyle = '#ffff99';
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          ctx.fillRect(-50 + i * 28, -50 + j * 28, 14, 14);
        }
      }
      ctx.restore();
    }

    function drawJacket(ctx, x, y) {
      ctx.save();
      ctx.translate(x, y);
      ctx.strokeStyle = '#888';
      ctx.lineWidth = 6;
      const legs = [{x: -90, offset: -50}, {x: 90, offset: -50}, {x: -80, offset: 60}, {x: 80, offset: 60}];
      legs.forEach(leg => {
        ctx.beginPath();
        ctx.moveTo(leg.x, -140);
        ctx.lineTo(leg.x + leg.offset, 140);
        ctx.stroke();
      });
      const colGrad = ctx.createLinearGradient(-40, -140, 40, 140);
      colGrad.addColorStop(0, '#d0d0d0');
      colGrad.addColorStop(1, '#606060');
      ctx.fillStyle = colGrad;
      ctx.fillRect(-40, -140, 80, 280);
      ctx.strokeStyle = '#222';
      ctx.lineWidth = 2;
      ctx.strokeRect(-40, -140, 80, 280);
      ctx.restore();
    }

    function drawRectangle(ctx, x, y) {
      ctx.save();
      ctx.translate(x, y);
      const grad = ctx.createLinearGradient(-80, -80, 80, 80);
      grad.addColorStop(0, '#c0c0c0');
      grad.addColorStop(1, '#707070');
      ctx.fillStyle = grad;
      ctx.fillRect(-80, -80, 160, 160);
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      ctx.strokeRect(-80, -80, 160, 160);
      ctx.restore();
    }

    function startGameLoop() {
      setInterval(() => {
        if (!gameActive) return;
        const elapsed = (Date.now() - gameStartTime) / 1000;
        const remaining = Math.max(0, 120 - elapsed); // 120 secondes = 2 minutes
        const minutes = Math.floor(remaining / 60);
        const seconds = Math.floor(remaining % 60);
        document.getElementById('timeDisplay').textContent = `${minutes}:${String(seconds).padStart(2, '0')}`;
        const timerPercent = (remaining / 120) * 100;
        document.getElementById('timerFill').style.width = timerPercent + '%';
        gameStats.quality = gameStats.productsInspected > 0
          ? Math.round((gameStats.productsGood / gameStats.productsInspected) * 100)
          : 0;
        document.getElementById('statsProducts').textContent = gameStats.productsInspected;
        document.getElementById('statsGood').textContent = gameStats.productsGood;
        document.getElementById('statsBad').textContent = gameStats.productsBad;
        document.getElementById('statsQuality').textContent = gameStats.quality + '%';
        updateQualitySmiley();
        document.getElementById('statsScore').textContent = gameStats.totalScore;
        document.getElementById('statsCombo').textContent = correctCombo;
        if (remaining <= 0) {
          gameActive = false;
          endGame();
        }
      }, 100);
    }

    function getRankInfo(score, quality, maxCombo) {
      if (score >= 3500 && quality >= 90 && maxCombo >= 15) return { letter: 'S', code: 's' };
      else if (score >= 3000 && quality >= 85 && maxCombo >= 12) return { letter: 'A', code: 'a' };
      else if (score >= 2500 && quality >= 80 && maxCombo >= 10) return { letter: 'B', code: 'b' };
      else if (score >= 2000 && quality >= 70 && maxCombo >= 7) return { letter: 'C', code: 'c' };
      else if (score >= 1500 && quality >= 60) return { letter: 'D', code: 'd' };
      else return { letter: 'E', code: 'e' };
    }

    window.endGame = function() {
      gameActive = false;
      mouseOverCanvas = false;
      document.getElementById('magnifier').style.display = 'none';
      document.getElementById('inspectionZone').style.display = 'none';

      const rank = getRankInfo(gameStats.totalScore, gameStats.quality, gameStats.maxCombo);
      const rankMessages = RANK_MESSAGES[currentLanguage][rank.letter];
      const randomMessage = rankMessages.messages[Math.floor(Math.random() * rankMessages.messages.length)];
      const avgTime = gameStats.productsInspected > 0 ? (gameStats.totalInspectionTime / gameStats.productsInspected).toFixed(1) : 0;

      document.querySelectorAll('.rank-node').forEach(node => node.classList.remove('active'));
      document.querySelector(`.rank-node.${rank.code}`).classList.add('active');

      document.getElementById('performanceEmoji').textContent = rankMessages.emoji;
      document.getElementById('performanceText').innerHTML = `<strong style="font-size: 1.3rem; color: #00A8E9;">${randomMessage}</strong>`;

      document.getElementById('finalName').textContent = ''; // Vide, sera rempli au submit
      document.getElementById('finalRatio').textContent = `${gameStats.productsGood}/${gameStats.productsInspected} = ${gameStats.quality}%`;
      document.getElementById('finalScore').textContent = gameStats.totalScore;
      document.getElementById('avgTime').textContent = avgTime + 's';
      document.getElementById('maxComboDisplay').textContent = gameStats.maxCombo;

      showScreen('endGameScreen');
    }

    window.submitScore = async function() {
      const name = document.getElementById('playerNameInput').value.trim();
      if (!name) { alert('Enter a name!'); return; }
      
      document.getElementById('finalName').textContent = `üèÜ ${name}`;
      
      // Supabase only gets: name, score, quality
      const scoreForCloud = {
        name: name, 
        score: gameStats.totalScore, 
        quality: gameStats.quality
      };
      
      // Local storage gets all data for leaderboard display
      const scoreForLocal = {
        name: name,
        score: gameStats.totalScore,
        quality: gameStats.quality,
        total_count: gameStats.productsInspected,
        good_count: gameStats.productsGood,
        timestamp: Date.now()
      };
      
      try {
        if (supabase && SUPABASE_URL && SUPABASE_URL !== 'https://xxxxx.supabase.co') {
          try {
            const { error } = await supabase.from('scores').insert([scoreForCloud]);
            if (error) {
              console.warn('‚ö†Ô∏è Supabase error, using localStorage:', error);
              saveToLocalStorage(scoreForLocal);
            } else {
              console.log('‚úÖ Score saved to cloud!');
              saveToLocalStorage(scoreForLocal);
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è Supabase exception:', e);
            saveToLocalStorage(scoreForLocal);
          }
        } else {
          console.log('‚ö†Ô∏è Supabase not configured');
          saveToLocalStorage(scoreForLocal);
        }
      } catch (err) {
        console.error('Error:', err);
        saveToLocalStorage(scoreForLocal);
      }
      
      showLeaderboard();
    }
    
    function saveToLocalStorage(score) {
      let leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
      leaderboard.push(score);
      leaderboard.sort((a, b) => b.score - a.score);
      leaderboard = leaderboard.slice(0, 20);
      localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
    }

    async function showLeaderboard() {
      const tbody = document.getElementById('leaderboardBody');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">Loading...</td></tr>';
      
      let leaderboard = [];
      
      try {
        // Essaie de charger depuis Supabase
        if (supabase && SUPABASE_URL !== 'https://xxxxx.supabase.co') {
          const { data, error } = await supabase
            .from('scores')
            .select('*')
            .order('score', { ascending: false })
            .limit(20);
          
          if (data && !error) {
            leaderboard = data;
            console.log('‚úÖ Leaderboard loaded from cloud!');
          } else {
            console.log('Using localStorage fallback');
            leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
          }
        } else {
          console.log('‚ö†Ô∏è Supabase not configured, using localStorage');
          leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
        }
      } catch (err) {
        console.error('Error loading leaderboard:', err);
        leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
      }
      
      tbody.innerHTML = '';
      if (leaderboard.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">No scores yet...</td></tr>';
        return;
      }
      
      leaderboard.forEach((entry, index) => {
        const tr = document.createElement('tr');
        const quality = entry.quality || Math.round((entry.good_count / entry.total_count) * 100);
        tr.innerHTML = `<td>${index + 1}</td><td><strong>${entry.name}</strong></td><td><strong style="color: #10B981; font-size: 1.2rem;">${entry.score}</strong></td><td>${entry.good_count}/${entry.total_count} = ${quality}%</td><td>${entry.avg_time}s</td>`;
        tbody.appendChild(tr);
      });
      
      // Ajouter source de donn√©es en bas
      const sourceRow = document.createElement('tr');
      sourceRow.style.background = 'rgba(168, 85, 247, 0.1)';
      let source = 'LOCAL (localStorage)';
      if (supabase && SUPABASE_URL !== 'https://xxxxx.supabase.co') {
        source = '‚òÅÔ∏è CLOUD (Supabase)';
      }
      sourceRow.innerHTML = `<td colspan="5" style="text-align: center; font-size: 0.85rem; color: #888; padding: 10px;">üìä Data from: ${source}</td>`;
      tbody.appendChild(sourceRow);
      
      showScreen('leaderboardScreen');
    }

    function showScreen(screenId) {
      document.querySelectorAll('.modal-overlay').forEach(s => s.classList.add('hidden'));
      const screen = document.getElementById(screenId);
      if (screen) screen.classList.remove('hidden');
    }

    // ===== EASTER EGGS & INTRO SCREEN =====
    let rulesClickCount = 0;

    function showIntroScreen() {
      const introScreen = document.getElementById('introScreenAnimated');
      if (introScreen) {
        introScreen.style.display = 'flex';
        loadIntroLeaderboard();
      }
    }

    function loadIntroLeaderboard() {
      const list = document.getElementById('introLeaderboardList');
      if (!list) return;
      const leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
      if (leaderboard.length === 0) return;
      
      list.innerHTML = '';
      leaderboard.slice(0, 10).forEach((score, idx) => {
        const now = new Date(score.timestamp || Date.now());
        const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        const quality = score.quality || 0;
        let grade = 'D'; if (quality >= 90) grade = 'A'; else if (quality >= 75) grade = 'B'; else if (quality >= 60) grade = 'C';
        
        const item = document.createElement('div');
        item.style.cssText = `padding: 12px; margin: 6px 0; background: linear-gradient(90deg, rgba(2,84,160,0.2) 0%, rgba(0,168,233,0.1) 100%); border-radius: 8px; border-left: 3px solid ${idx === 0 ? '#FFD700' : '#FF5716'};`;
        item.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;"><div style="flex: 1;"><div style="font-weight: 900; color: white; font-size: 1rem;">${score.name}</div><div style="color: #888; font-size: 0.8rem;">${dateStr} ${timeStr}</div></div><div style="text-align: right;"><div style="font-size: 1.1rem; font-weight: 900; color: ${grade === 'A' ? '#00FF00' : grade === 'B' ? '#FFD700' : '#FF8C00'};">${grade}</div><div style="color: #FF5716; font-weight: bold;">${score.score}pts</div></div></div><div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px; font-size: 0.75rem;"><div style="background: rgba(0,168,233,0.2); padding: 4px; border-radius: 3px; text-align: center;"><div style="color: #00A8E9;">${score.total_count || 30}</div><div style="color: #888;">Inspected</div></div><div style="background: rgba(0,255,0,0.2); padding: 4px; border-radius: 3px; text-align: center;"><div style="color: #00FF00;">${score.good_count || 0}</div><div style="color: #888;">Good</div></div><div style="background: rgba(255,215,0,0.2); padding: 4px; border-radius: 3px; text-align: center;"><div style="color: #FFD700;">${quality}%</div><div style="color: #888;">Ratio</div></div></div>`;
        list.appendChild(item);
      });
    }

    function triggerEasterEgg() {
      const overlay = document.getElementById('easterOverlay');
      if (overlay) {
        overlay.style.display = 'flex';
        createFireworks();
        setTimeout(() => { overlay.style.display = 'none'; }, 5000);
      }
    }

    function createFireworks() {
      const container = document.getElementById('fireworksContainer');
      if (!container) return;
      container.innerHTML = '';
      const colors = ['#FF5716', '#FFD700', '#00A8E9', '#0254A0', '#FF1493', '#00FF00'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const fw = document.createElement('div');
          fw.className = 'firework';
          fw.style.background = colors[Math.floor(Math.random() * colors.length)];
          fw.style.left = (40 + Math.random() * 20) + '%';
          fw.style.top = (40 + Math.random() * 20) + '%';
          fw.style.setProperty('--tx', (Math.random() - 0.5) * 400 + 'px');
          fw.style.setProperty('--ty', (Math.random() - 0.5) * 400 + 'px');
          fw.style.animation = `firework ${0.8 + Math.random() * 0.4}s ease-out forwards`;
          container.appendChild(fw);
        }, i * 30);
      }
    }

    window.addEventListener('load', () => {
      showIntroScreen();
      const rulesTrigger = document.getElementById('rulesTrigger');
      if (rulesTrigger) {
        rulesTrigger.addEventListener('click', () => {
          rulesClickCount++;
          if (rulesClickCount === 10) { triggerEasterEgg(); rulesClickCount = 0; }
        });
      }
    });
  </script>
</body>
</html>